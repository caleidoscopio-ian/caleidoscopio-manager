
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================
// SISTEMA 1 - CÉREBRO CENTRAL (MULTI-TENANT)
// =====================================

// Modelo para representar cada clínica/tenant
model Tenant {
  id        String   @id @default(cuid())
  name      String   // Nome da clínica
  slug      String   @unique // Identificador único (ex: "clinica-sp")
  domain    String?  // Domínio personalizado opcional
  status    TenantStatus @default(ACTIVE)
  
  // Dados empresariais
  cnpj         String? // CNPJ da empresa
  razaoSocial  String? // Razão social da empresa
  
  // Endereço completo
  cep          String? // CEP
  endereco     String? // Endereço completo (rua, número, complemento)
  cidade       String? // Cidade
  estado       String? // Estado (UF)
  
  // Plano e licenciamento
  planId    String
  plan      Plan     @relation(fields: [planId], references: [id])
  maxUsers  Int      @default(10) // Limite de usuários
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  users           User[]
  tenantProducts  TenantProduct[]
  
  @@map("tenants")
}

// Planos disponíveis
model Plan {
  id          String   @id @default(cuid())
  name        String   // Ex: "Básico", "Premium", "Enterprise"
  slug        String   @unique
  description String?
  maxUsers    Int      // Limite de usuários por plano
  features    String[] // Array de features habilitadas
  price       Decimal? // Preço mensal
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  tenants      Tenant[]
  planProducts PlanProduct[]
  
  @@map("plans")
}

// Usuários globais (Super Admin) e por tenant
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // Hash da senha
  
  // Multi-tenancy
  tenantId  String?  // NULL para super admins
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Controle de acesso
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  
  // Dados de acesso
  lastLogin DateTime?
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  sessions      Session[]
  productTokens ProductToken[]
  
  @@map("users")
}

// Sessões de usuário
model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  
  createdAt DateTime @default(now())
  
  @@map("sessions")
}

// Logs de auditoria
model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String?  // NULL para ações globais
  userId    String?  // NULL para ações do sistema
  action    String   // Ex: "CREATE_USER", "LOGIN", "DELETE_TENANT"
  resource  String?  // Recurso afetado (ex: "user:123")
  details   Json?    // Detalhes adicionais da ação
  
  createdAt DateTime @default(now())
  
  @@map("audit_logs")
}

// =====================================
// SISTEMA DE PRODUTOS DO ECOSSISTEMA
// =====================================

// Produtos disponíveis no ecossistema
model Product {
  id          String   @id @default(cuid())
  name        String   // Ex: "E-commerce", "Educacional", "Telemedicina"
  slug        String   @unique // Ex: "ecommerce", "education", "telemedicine"
  description String?  // Descrição do produto
  icon        String?  // Nome do ícone (lucide-react)
  color       String?  // Cor tema do produto (#hex)
  baseUrl     String?  // URL base do produto (para SSO)
  isActive    Boolean  @default(true)
  
  // Configurações padrão do produto
  defaultConfig Json?   // Configurações padrão quando ativado
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  planProducts   PlanProduct[]
  tenantProducts TenantProduct[]
  productTokens  ProductToken[]
  
  @@map("products")
}

// Relacionamento entre planos e produtos (quais produtos cada plano inclui)
model PlanProduct {
  id        String  @id @default(cuid())
  planId    String
  productId String
  plan      Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Configurações específicas do produto para este plano
  config    Json?   // Ex: limites, features específicas, restrições
  isActive  Boolean @default(true)
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([planId, productId])
  @@map("plan_products")
}

// Produtos ativos para cada tenant/clínica
model TenantProduct {
  id         String   @id @default(cuid())
  tenantId   String
  productId  String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Status e configurações
  isActive    Boolean  @default(true)
  config      Json?    // Configurações específicas para este tenant
  activatedAt DateTime @default(now())
  
  // Dados de uso (para analytics)
  lastAccessed DateTime?
  accessCount  Int      @default(0)
  
  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([tenantId, productId])
  @@map("tenant_products")
}

// Tokens de acesso para produtos (SSO)
model ProductToken {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Controle de acesso
  expiresAt  DateTime
  isRevoked  Boolean  @default(false)
  
  // Metadados
  createdAt  DateTime @default(now())
  lastUsed   DateTime?
  
  @@map("product_tokens")
}

// =====================================
// ENUMS
// =====================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum UserRole {
  SUPER_ADMIN  // Acesso total ao sistema
  ADMIN        // Admin de tenant específico
  USER         // Usuário regular
}
